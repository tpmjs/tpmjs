name: Sync NPM Keyword Search

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  sync-keyword:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger keyword search sync
        id: sync
        run: |
          # Call the sync API and capture response
          response=$(curl -X POST "${{ secrets.VERCEL_PRODUCTION_URL }}/api/sync/keyword" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -f -s -S)

          echo "Response: $response"

          # Extract data using jq
          processed=$(echo "$response" | jq -r '.data.processed')
          skipped=$(echo "$response" | jq -r '.data.skipped')
          errors=$(echo "$response" | jq -r '.data.errors')
          packagesFound=$(echo "$response" | jq -r '.data.packagesFound')
          durationMs=$(echo "$response" | jq -r '.data.durationMs')

          # Extract and display error messages
          errorMessages=$(echo "$response" | jq -r '.data.errorMessages[]?' 2>/dev/null || echo "")

          if [ -n "$errorMessages" ]; then
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚ö†Ô∏è  SYNC ERRORS ($errors total):"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "$response" | jq -r '.data.errorMessages[]?' | while IFS= read -r error; do
              echo "  ‚Ä¢ $error"
            done
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          fi

          # Set outputs for Discord notification
          echo "processed=$processed" >> $GITHUB_OUTPUT
          echo "skipped=$skipped" >> $GITHUB_OUTPUT
          echo "errors=$errors" >> $GITHUB_OUTPUT
          echo "packagesFound=$packagesFound" >> $GITHUB_OUTPUT
          echo "durationMs=$durationMs" >> $GITHUB_OUTPUT

          # Store error messages for Discord (first 3, truncated)
          if [ "$errors" -gt 0 ]; then
            errorSummary=$(echo "$response" | jq -r '.data.errorMessages[0:3]? | join("\n‚Ä¢ ")' 2>/dev/null || echo "")
            if [ -n "$errorSummary" ]; then
              # Save to file to preserve newlines
              echo "‚Ä¢ $errorSummary" > /tmp/error_summary.txt
            fi
          fi

          # Determine status emoji
          if [ "$errors" -gt 0 ]; then
            echo "status_emoji=‚ö†Ô∏è" >> $GITHUB_OUTPUT
            echo "status_color=16776960" >> $GITHUB_OUTPUT  # Yellow
          else
            echo "status_emoji=‚úÖ" >> $GITHUB_OUTPUT
            echo "status_color=5763719" >> $GITHUB_OUTPUT   # Green
          fi

      - name: Send Discord notification
        if: always()
        run: |
          # Format duration
          duration_sec=$(echo "scale=2; ${{ steps.sync.outputs.durationMs }} / 1000" | bc)

          # Build Discord payload using jq for proper JSON escaping
          if [ -f /tmp/error_summary.txt ] && [ ${{ steps.sync.outputs.errors }} -gt 0 ]; then
            # Read and truncate error text
            error_text=$(cat /tmp/error_summary.txt | head -c 800)

            # Create payload with error details using jq
            payload=$(jq -n \
              --arg title "${{ steps.sync.outputs.status_emoji }} NPM Keyword Search Sync" \
              --argjson color ${{ steps.sync.outputs.status_color }} \
              --arg packages "${{ steps.sync.outputs.packagesFound }}" \
              --arg processed "${{ steps.sync.outputs.processed }}" \
              --arg skipped "${{ steps.sync.outputs.skipped }}" \
              --arg errors "${{ steps.sync.outputs.errors }}" \
              --arg duration "${duration_sec}s" \
              --arg url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
              --arg error_text "$error_text" \
              --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
              '{
                embeds: [{
                  title: $title,
                  color: $color,
                  fields: [
                    { name: "üì¶ Packages Found", value: $packages, inline: true },
                    { name: "‚ú® Processed", value: $processed, inline: true },
                    { name: "‚è≠Ô∏è Skipped", value: $skipped, inline: true },
                    { name: "‚ùå Errors", value: $errors, inline: true },
                    { name: "‚è±Ô∏è Duration", value: $duration, inline: true },
                    { name: "üîó Run", value: ("[View Logs](" + $url + ")"), inline: true },
                    { name: "üîç Error Details", value: ("```\n" + $error_text + "\n```"), inline: false }
                  ],
                  timestamp: $timestamp
                }]
              }')
          else
            # Create payload without error details
            payload=$(jq -n \
              --arg title "${{ steps.sync.outputs.status_emoji }} NPM Keyword Search Sync" \
              --argjson color ${{ steps.sync.outputs.status_color }} \
              --arg packages "${{ steps.sync.outputs.packagesFound }}" \
              --arg processed "${{ steps.sync.outputs.processed }}" \
              --arg skipped "${{ steps.sync.outputs.skipped }}" \
              --arg errors "${{ steps.sync.outputs.errors }}" \
              --arg duration "${duration_sec}s" \
              --arg url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
              --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
              '{
                embeds: [{
                  title: $title,
                  color: $color,
                  fields: [
                    { name: "üì¶ Packages Found", value: $packages, inline: true },
                    { name: "‚ú® Processed", value: $processed, inline: true },
                    { name: "‚è≠Ô∏è Skipped", value: $skipped, inline: true },
                    { name: "‚ùå Errors", value: $errors, inline: true },
                    { name: "‚è±Ô∏è Duration", value: $duration, inline: true },
                    { name: "üîó Run", value: ("[View Logs](" + $url + ")"), inline: true }
                  ],
                  timestamp: $timestamp
                }]
              }')
          fi

          # Send to Discord
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$payload"
