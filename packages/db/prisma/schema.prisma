// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Direct connection for migrations (bypasses pooler)
}

/// Package table - stores NPM package metadata (package-level)
model Package {
  id String @id @default(cuid())

  // NPM Metadata
  npmPackageName String   @unique @map("npm_package_name") @db.VarChar(214)
  npmVersion     String   @map("npm_version") @db.VarChar(50)
  npmPublishedAt DateTime @map("npm_published_at")
  npmDescription String?  @map("npm_description") @db.Text
  npmRepository  Json?    @map("npm_repository") @db.JsonB
  npmHomepage    String?  @map("npm_homepage") @db.Text
  npmLicense     String?  @map("npm_license") @db.VarChar(50)
  npmKeywords    String[] @default([]) @map("npm_keywords") @db.Text
  npmReadme      String?  @map("npm_readme") @db.Text
  npmAuthor      Json?    @map("npm_author") @db.JsonB
  npmMaintainers Json?    @map("npm_maintainers") @db.JsonB

  // TPMJS Package-Level Metadata
  category       String   @db.VarChar(50)
  env            Json?    @db.JsonB // Environment variables (shared across tools)
  frameworks     String[] @default([]) @db.Text
  tier           String   @db.VarChar(20) // 'minimal' | 'rich'
  discoveryMethod String  @map("discovery_method") @db.VarChar(20) // 'keyword' | 'changes-feed'
  isOfficial     Boolean  @default(false) @map("is_official")

  // Package Metrics
  npmDownloadsLastMonth Int? @default(0) @map("npm_downloads_last_month")
  githubStars           Int? @default(0) @map("github_stars")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tools Tool[]

  @@index([category])
  @@index([isOfficial])
  @@index([npmDownloadsLastMonth])
  @@index([createdAt])
  @@map("packages")
}

/// Tool table - stores individual tools within packages
model Tool {
  id String @id @default(cuid())

  // Package Relation
  packageId String  @map("package_id")
  package   Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

  // Tool Identity
  name String @db.VarChar(100) // e.g., "helloWorldTool", "default"

  // Tool Metadata
  description String @db.Text
  parameters  Json?  @db.JsonB // Legacy/fallback - author-provided parameters array
  returns     Json?  @db.JsonB // @deprecated - will be auto-extracted in future
  aiAgent     Json?  @map("ai_agent") @db.JsonB // @deprecated - will be auto-extracted in future

  // Schema Extraction Fields
  inputSchema                Json?     @map("input_schema") @db.JsonB // Full JSON Schema from executor
  schemaSource               String?   @map("schema_source") @db.VarChar(20) // 'extracted' | 'author' | null
  schemaExtractedAt          DateTime? @map("schema_extracted_at") // Only updated on successful extraction
  schemaExtractionAttemptAt  DateTime? @map("schema_extraction_attempt_at") // Updated on every attempt (for rate limiting)
  schemaExtractionError      String?   @map("schema_extraction_error") @db.Text // Error message from last failed attempt

  // Tool Discovery Fields
  toolDiscoverySource String? @map("tool_discovery_source") @db.VarChar(20) // 'auto' | 'manual' | null

  // Tool Metrics
  qualityScore Decimal? @map("quality_score") @db.Decimal(3, 2) // 0.00 to 1.00
  likeCount    Int      @default(0) @map("like_count")

  // Health Status Fields
  importHealth     HealthStatus? @default(UNKNOWN) @map("import_health")
  executionHealth  HealthStatus? @default(UNKNOWN) @map("execution_health")
  lastHealthCheck  DateTime?     @map("last_health_check")
  healthCheckError String?       @map("health_check_error") @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  simulations  Simulation[]
  healthChecks HealthCheck[]
  collections  CollectionTool[]
  agents       AgentTool[]
  likes        ToolLike[]

  @@unique([packageId, name])
  @@index([qualityScore])
  @@index([likeCount])
  @@index([importHealth])
  @@index([executionHealth])
  @@index([lastHealthCheck])
  @@map("tools")
}

/// Sync checkpoints - tracks progress of sync workers
model SyncCheckpoint {
  id String @id @default(cuid())

  source     String   @unique @db.VarChar(50) // 'changes-feed' | 'keyword-search' | 'metrics'
  checkpoint Json     @db.JsonB // Stores last sequence, timestamp, etc.
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("sync_checkpoints")
}

/// Sync logs - audit trail of sync operations
model SyncLog {
  id String @id @default(cuid())

  source    String   @db.VarChar(50) // 'changes-feed' | 'keyword-search' | 'metrics'
  status    String   @db.VarChar(20) // 'success' | 'error' | 'partial'
  processed Int      @default(0) // Number of packages processed
  skipped   Int      @default(0) // Number of packages skipped
  errors    Int      @default(0) // Number of errors encountered
  message   String?  @db.Text // Error message or summary
  metadata  Json?    @db.JsonB // Additional context
  createdAt DateTime @default(now()) @map("created_at")

  @@index([source])
  @@index([status])
  @@index([createdAt])
  @@map("sync_logs")
}

/// Simulations - tracks tool playground executions
model Simulation {
  id String @id @default(cuid())

  // Relations
  toolId String @map("tool_id")
  tool   Tool   @relation(fields: [toolId], references: [id], onDelete: Cascade)

  // Request data
  userPrompt String  @map("user_prompt") @db.Text
  parameters Json?   @db.JsonB
  ipAddress  String? @map("ip_address") @db.VarChar(45)
  userAgent  String? @map("user_agent") @db.Text

  // Results
  status          String  @db.VarChar(20) // pending|running|success|error|timeout
  executionTimeMs Int?    @map("execution_time_ms")
  output          Json?   @db.JsonB
  error           String? @db.Text

  // AI metadata
  agentSteps Int     @default(0) @map("agent_steps")
  model      String? @db.VarChar(50)

  // Relations
  tokenUsage   TokenUsage?
  logs         ExecutionLog[]

  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  @@index([toolId])
  @@index([status])
  @@index([ipAddress, createdAt]) // For rate limiting
  @@map("simulations")
}

/// Token usage - tracks token consumption per simulation
model TokenUsage {
  id String @id @default(cuid())

  simulationId String     @unique @map("simulation_id")
  simulation   Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)

  inputTokens    Int      @default(0) @map("input_tokens")
  toolDescTokens Int      @default(0) @map("tool_desc_tokens")
  schemaTokens   Int      @default(0) @map("schema_tokens")
  outputTokens   Int      @default(0) @map("output_tokens")
  totalTokens    Int      @default(0) @map("total_tokens")
  estimatedCost  Decimal? @map("estimated_cost") @db.Decimal(10, 6)

  createdAt DateTime @default(now()) @map("created_at")
  @@map("token_usage")
}

/// Execution logs - detailed logs for each simulation
model ExecutionLog {
  id String @id @default(cuid())

  simulationId String     @map("simulation_id")
  simulation   Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())
  level     String   @db.VarChar(20) // info|warning|error|debug
  event     String   @db.VarChar(50)
  message   String   @db.Text
  metadata  Json?    @db.JsonB

  @@index([simulationId])
  @@map("execution_logs")
}

/// HealthCheck table - tracks full audit history of health checks
model HealthCheck {
  id String @id @default(cuid())

  // Relations
  toolId String @map("tool_id")
  tool   Tool   @relation(fields: [toolId], references: [id], onDelete: Cascade)

  // Check metadata
  checkType     HealthCheckType @map("check_type")
  triggerSource String          @map("trigger_source") @db.VarChar(50) // 'sync' | 'manual' | 'daily-cron'

  // Import check results
  importStatus HealthStatus @map("import_status")
  importError  String?      @map("import_error") @db.Text
  importTimeMs Int?         @map("import_time_ms")

  // Execution check results
  executionStatus HealthStatus @map("execution_status")
  executionError  String?      @map("execution_error") @db.Text
  executionTimeMs Int?         @map("execution_time_ms")
  testParameters  Json?        @map("test_parameters") @db.JsonB

  // Overall status
  overallStatus HealthStatus @map("overall_status")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([toolId])
  @@index([checkType])
  @@index([overallStatus])
  @@index([createdAt])
  @@map("health_checks")
}

/// Health status enum - tracks health check results
enum HealthStatus {
  UNKNOWN // Not yet checked
  HEALTHY // Passed health check
  BROKEN  // Failed health check
}

/// Health check type enum - types of health checks performed
enum HealthCheckType {
  IMPORT    // Only import check
  EXECUTION // Only execution check
  FULL      // Both import and execution
}

/// StatsSnapshot - daily snapshot of registry statistics for historical tracking
model StatsSnapshot {
  id String @id @default(cuid())

  // Snapshot date (one per day)
  date DateTime @unique @db.Date

  // Registry Overview
  totalTools      Int @default(0) @map("total_tools")
  totalPackages   Int @default(0) @map("total_packages")
  officialTools   Int @default(0) @map("official_tools")
  officialPackages Int @default(0) @map("official_packages")
  toolsWithSchema Int @default(0) @map("tools_with_schema")

  // Downloads & Stars
  totalNpmDownloads Int @default(0) @map("total_npm_downloads")
  totalGithubStars  Int @default(0) @map("total_github_stars")

  // Health Status Counts
  importHealthy   Int @default(0) @map("import_healthy")
  importBroken    Int @default(0) @map("import_broken")
  importUnknown   Int @default(0) @map("import_unknown")
  executionHealthy Int @default(0) @map("execution_healthy")
  executionBroken  Int @default(0) @map("execution_broken")
  executionUnknown Int @default(0) @map("execution_unknown")

  // Quality Distribution (stored as JSON for flexibility)
  qualityDistribution Json? @map("quality_distribution") @db.JsonB

  // Package Tiers
  tiersMinimal Int @default(0) @map("tiers_minimal")
  tiersRich    Int @default(0) @map("tiers_rich")

  // Execution Stats (daily)
  executionsTotal      Int @default(0) @map("executions_total")
  executionsSuccessful Int @default(0) @map("executions_successful")
  executionsFailed     Int @default(0) @map("executions_failed")
  executionsAvgTimeMs  Int? @map("executions_avg_time_ms")

  // Token Usage (daily)
  tokensInput    BigInt @default(0) @map("tokens_input")
  tokensOutput   BigInt @default(0) @map("tokens_output")
  tokensTotal    BigInt @default(0) @map("tokens_total")
  tokensCostUsd  Decimal? @map("tokens_cost_usd") @db.Decimal(10, 4)

  // Health Checks (daily)
  healthChecksRun Int @default(0) @map("health_checks_run")

  // Category Breakdown (stored as JSON)
  categories Json? @db.JsonB

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([date])
  @@map("stats_snapshots")
}

// ============================================================================
// Better Auth Models
// ============================================================================

/// User table - stores authenticated users
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false) @map("email_verified")
  image         String?
  username      String?   @unique @db.VarChar(30) // URL-friendly username (nullable for migration)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sessions        Session[]
  accounts        Account[]
  collections     Collection[]
  agents          Agent[]
  apiKeys         UserApiKey[]
  toolLikes       ToolLike[]
  collectionLikes CollectionLike[]
  agentLikes      AgentLike[]
  activities      UserActivity[]

  @@index([username])
  @@map("users")
}

/// Session table - stores user sessions
model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

/// Account table - stores auth provider accounts (including email/password)
model Account {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  accountId    String    @map("account_id")
  providerId   String    @map("provider_id")
  accessToken  String?   @map("access_token") @db.Text
  refreshToken String?   @map("refresh_token") @db.Text
  idToken      String?   @map("id_token") @db.Text
  expiresAt    DateTime? @map("expires_at")
  password     String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("accounts")
}

/// Verification table - stores email verification tokens
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("verifications")
}

// ============================================================================
// Collection Models
// ============================================================================

/// Collection - user-created groups of tools
model Collection {
  id          String   @id @default(cuid())

  // Owner relationship
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Collection metadata
  name        String   @db.VarChar(100)
  slug        String?  @db.VarChar(50) // URL-friendly identifier (nullable for migration)
  description String?  @db.VarChar(500)
  isPublic    Boolean  @default(false) @map("is_public")
  likeCount   Int      @default(0) @map("like_count")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tools       CollectionTool[]
  agents      AgentCollection[]
  likes       CollectionLike[]

  // Unique constraint: user can't have duplicate collection slugs
  @@unique([userId, slug])
  @@index([userId])
  @@index([slug])
  @@index([isPublic])
  @@index([likeCount])
  @@index([createdAt])
  @@map("collections")
}

/// CollectionTool - junction table for many-to-many relationship between collections and tools
model CollectionTool {
  id           String     @id @default(cuid())

  // Relationships
  collectionId String     @map("collection_id")
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  toolId       String     @map("tool_id")
  tool         Tool       @relation(fields: [toolId], references: [id], onDelete: Cascade)

  // Ordering - allows users to reorder tools within a collection
  position     Int        @default(0)

  // Optional user notes about why this tool is in the collection
  note         String?    @db.VarChar(500)

  // Timestamps
  addedAt      DateTime   @default(now()) @map("added_at")

  // Unique constraint: tool can only be in a collection once
  @@unique([collectionId, toolId])
  @@index([collectionId])
  @@index([toolId])
  @@map("collection_tools")
}

// ============================================================================
// Agent Models
// ============================================================================

/// AI Provider enum - supported LLM providers
enum AIProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  GROQ
  MISTRAL
}

/// Message role enum - conversation message types
enum MessageRole {
  USER
  ASSISTANT
  TOOL
  SYSTEM
}

/// Agent - user-owned AI agent configurations
model Agent {
  id                   String     @id @default(cuid())

  // Owner relationship
  userId               String     @map("user_id")
  user                 User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Agent identity
  uid                  String     @unique @db.VarChar(50) // URL-friendly identifier
  name                 String     @db.VarChar(100)
  description          String?    @db.VarChar(500)

  // Model configuration
  provider             AIProvider
  modelId              String     @map("model_id") @db.VarChar(100)
  systemPrompt         String?    @map("system_prompt") @db.Text
  temperature          Float      @default(0.7)
  maxToolCallsPerTurn  Int        @default(20) @map("max_tool_calls_per_turn")
  maxMessagesInContext Int        @default(10) @map("max_messages_in_context")

  // Visibility
  isPublic             Boolean    @default(true) @map("is_public")
  likeCount            Int        @default(0) @map("like_count")

  // Timestamps
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")

  // Relations
  collections          AgentCollection[]
  tools                AgentTool[]
  conversations        Conversation[]
  likes                AgentLike[]

  @@unique([userId, name])
  @@index([userId])
  @@index([uid])
  @@index([isPublic])
  @@index([likeCount])
  @@index([createdAt])
  @@map("agents")
}

/// AgentCollection - junction table for Agent -> Collection (many-to-many)
model AgentCollection {
  id           String     @id @default(cuid())

  // Relationships
  agentId      String     @map("agent_id")
  agent        Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)
  collectionId String     @map("collection_id")
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  // Ordering
  position     Int        @default(0)

  // Timestamps
  addedAt      DateTime   @default(now()) @map("added_at")

  @@unique([agentId, collectionId])
  @@index([agentId])
  @@index([collectionId])
  @@map("agent_collections")
}

/// AgentTool - junction table for Agent -> Tool (many-to-many)
model AgentTool {
  id        String   @id @default(cuid())

  // Relationships
  agentId   String   @map("agent_id")
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  toolId    String   @map("tool_id")
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)

  // Ordering
  position  Int      @default(0)

  // Timestamps
  addedAt   DateTime @default(now()) @map("added_at")

  @@unique([agentId, toolId])
  @@index([agentId])
  @@index([toolId])
  @@map("agent_tools")
}

/// UserApiKey - encrypted API keys/env vars per user
model UserApiKey {
  id           String   @id @default(cuid())

  // Owner relationship
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Key identification (e.g. OPENAI_API_KEY, MY_SECRET, etc.)
  keyName      String   @map("key_name") @db.VarChar(100)

  // Encrypted key storage
  encryptedKey String   @map("encrypted_key") @db.Text
  keyIv        String   @map("key_iv") @db.VarChar(32)
  keyHint      String?  @map("key_hint") @db.VarChar(10) // Last 4 chars

  // Timestamps
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([userId, keyName])
  @@index([userId])
  @@map("user_api_keys")
}

/// Conversation - chat session with an agent
model Conversation {
  id          String    @id @default(cuid())

  // Agent relationship
  agentId     String    @map("agent_id")
  agent       Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Conversation identity
  slug        String    @db.VarChar(100) // User-chosen unique ID

  // Metadata
  title       String?   @db.VarChar(200)

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  messages    Message[]

  @@unique([agentId, slug])
  @@index([agentId])
  @@index([createdAt])
  @@map("conversations")
}

/// Message - individual message in a conversation
model Message {
  id             String       @id @default(cuid())

  // Conversation relationship
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Message content
  role           MessageRole
  content        String       @db.Text

  // Tool call metadata (for role=ASSISTANT with tool calls)
  toolCalls      Json?        @map("tool_calls") @db.JsonB

  // Tool result metadata (for role=TOOL)
  toolCallId     String?      @map("tool_call_id") @db.VarChar(100)
  toolName       String?      @map("tool_name") @db.VarChar(200)
  toolResult     Json?        @map("tool_result") @db.JsonB

  // Token tracking
  inputTokens    Int?         @map("input_tokens")
  outputTokens   Int?         @map("output_tokens")

  // Timestamps
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

// ============================================================================
// Like Models
// ============================================================================

/// ToolLike - tracks users who liked a tool
model ToolLike {
  id        String   @id @default(cuid())

  // Relationships
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  toolId    String   @map("tool_id")
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, toolId])
  @@index([toolId])
  @@index([userId])
  @@map("tool_likes")
}

/// CollectionLike - tracks users who liked a collection
model CollectionLike {
  id           String     @id @default(cuid())

  // Relationships
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  collectionId String     @map("collection_id")
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt    DateTime   @default(now()) @map("created_at")

  @@unique([userId, collectionId])
  @@index([collectionId])
  @@index([userId])
  @@map("collection_likes")
}

/// AgentLike - tracks users who liked an agent
model AgentLike {
  id        String   @id @default(cuid())

  // Relationships
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  agentId   String   @map("agent_id")
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, agentId])
  @@index([agentId])
  @@index([userId])
  @@map("agent_likes")
}

// ============================================================================
// Activity Stream Models
// ============================================================================

/// Activity type enum - types of user activities tracked
enum ActivityType {
  AGENT_CREATED
  AGENT_UPDATED
  AGENT_DELETED
  AGENT_CLONED
  AGENT_TOOL_ADDED
  AGENT_TOOL_REMOVED
  AGENT_COLLECTION_ADDED
  AGENT_COLLECTION_REMOVED
  COLLECTION_CREATED
  COLLECTION_UPDATED
  COLLECTION_DELETED
  COLLECTION_CLONED
  COLLECTION_TOOL_ADDED
  COLLECTION_TOOL_REMOVED
  TOOL_LIKED
  TOOL_UNLIKED
  COLLECTION_LIKED
  COLLECTION_UNLIKED
  AGENT_LIKED
  AGENT_UNLIKED
}

/// UserActivity - tracks user actions for activity stream
model UserActivity {
  id           String       @id @default(cuid())

  // Owner relationship
  userId       String       @map("user_id")
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Activity type
  type         ActivityType

  // Optional entity references (for linking to entities if they still exist)
  agentId      String?      @map("agent_id")
  collectionId String?      @map("collection_id")
  toolId       String?      @map("tool_id")

  // Denormalized fields (stored at creation time for display even after entity deletion)
  targetName   String       @map("target_name") @db.VarChar(200)
  targetType   String       @map("target_type") @db.VarChar(50) // 'agent' | 'collection' | 'tool'

  // Additional context (e.g., toolName when adding to collection)
  metadata     Json?        @db.JsonB

  // Timestamps
  createdAt    DateTime     @default(now()) @map("created_at")

  @@index([userId])
  @@index([userId, createdAt])
  @@index([type])
  @@index([createdAt])
  @@map("user_activities")
}
